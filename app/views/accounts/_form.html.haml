%p
  = f.label :organization_id
  %span#select_orgs_block
  = f.hidden_field :organization_id
  = link_to "new", new_organization_linein_path, :class => 'badge_trigger_load'
%p
  = f.label :current_balance
  = f.text_field :current_balance, :size => 15

- unless f.object.new_record?
  #contacts_block
    %fieldset#contacts_list
      %legend Contacts
      %ul
        - for person in f.object.people_list
          - contact = f.object.account_people.find_by_person_id( person.id )
          %li
            = link_to person.name, edit_person_linein_path( contact ), :class => 'remote_sidebar', :metadata => { :remote_domain => linein_host, :selector => '.ui-block:has(form.edit_person)' }.to_json
            = link_to 'affiliation', edit_account_person_path( contact ), :class => 'remote_sidebar', :metadata => { :selector => '.ui-block:has(form.edit_account_person)' }.to_json
      = link_to "new contact", new_organization_person_linein_path( f.object.organization_id ), :class => 'remote_sidebar', :metadata => { :remote_domain => linein_host, :selector => '.ui-block:has(form.new_person)' }.to_json
      = link_to "add affiliation", new_account_account_person_path( f.object ), :class => 'remote_sidebar', :metadata => { :selector => '.ui-block:has(form.new_account_person)' }.to_json

-content_for :sidebar do
  #sidebar_inset.js-staging

-content_for :dom_ready do
  :plain
    //account_person name select
    #{ render :partial => 'account_people/form_script' }

    //remote_sidebar
    $('.remote_sidebar').livequery('click', function() {
      var meta = $(this).metadata();
      $('#sidebar_inset').load( $(this).attr('href') + ' '  + meta.selector, function( response ) {
        $('#sidebar_inset').show('slow');
        if( meta.remote_domain !== undefined ) {
          $('#sidebar_inset a').each( RD.ui.remote_connect( meta.remote_domain, 'href' ) );
          $('#sidebar_inset form').each( RD.ui.remote_connect( meta.remote_domain, 'action' ) );
        }
      });
      return false;
    } );

    //contacts list
    $('#contacts_block').bind( 'refresh', function() {
      $(this).load( window.location + ' #contacts_list' );
    } );


    //submit sidebar
    $('#sidebar_inset form[id*=person]:not(#new_person)').livequery('submit', function() {
      $(this).fn( RD.remote_form( { response: function( response ) {
        $('#contacts_block').trigger('refresh');
        $('#sidebar_inset *').remove();
      } } ) );
      $(this).fn('submit', 'json');
      return false;
    } );
  
    //submit new linked person
    $('form#new_linked_person').livequery('submit', function() {
      $(this).fn( RD.remote_form( { response: function( response ) {
        $('#contacts_block').trigger('refresh');
      }} ));
      return $(this).fn('submit', 'json');
    } );

    //submit new person
    $('#sidebar_inset form#new_person').livequery( function() {
      $(this).fn( RD.remote_form( { response: function( response ) {
        if( response.person.id ) {
          $('form#new_linked_person #account_person_person_id').val( response.person.id );
          $('form#new_linked_person').submit();
        }
        $('#sidebar_inset *').remove();
      }}));
      $(this).submit( function() { return $(this).fn('submit', 'json'); } );
    } );

    //delete link
    $('.show_delete_block').livequery( 'click', function() { $(this).next('.delete_block').toggle(); return false; } ); 

